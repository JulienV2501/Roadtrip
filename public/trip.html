<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Voyage ‚Äî Template</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap"
    rel="stylesheet"
  >

  <style>
    :root {
      --bg: #050816;
      --bg-alt: #071021;
      --panel: #0c1424;
      --card: #111827;
      --accent: #7bd3ff;
      --accent-soft: rgba(123, 211, 255, 0.18);
      --danger: #f97373;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --border-subtle: #1f2937;
      --border-strong: #334155;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.75);
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-pill: 999px;
      --detail-initial-width: 55%;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: radial-gradient(circle at top left, #111827 0, #020617 55%);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 14px;
      line-height: 1.6;
    }

    .app-shell {
      min-height: 100vh;
      display: grid;
      grid-template-rows: auto 1fr;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 20;
      background: linear-gradient(180deg, rgba(15,23,42,0.98), rgba(15,23,42,0.9));
      border-bottom: 1px solid var(--border-subtle);
      backdrop-filter: blur(14px);
      padding: 12px 18px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .header-left {
      display: flex;
      flex-direction: column;
    }

    h1 {
      margin: 0;
      font-family: "Space Grotesk", system-ui;
      font-size: 18px;
      letter-spacing: 0.04em;
    }

    .subtitle {
      margin-top: 2px;
      color: var(--muted);
      font-size: 12px;
    }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    main {
      display: grid;
      grid-template-columns:
        minmax(240px, 260px)
        minmax(0, 1fr);
      gap: 0;
      min-height: calc(100vh - 48px);
    }

    .sidebar {
      border-right: 1px solid var(--border-subtle);
      background:
        radial-gradient(circle at top left, rgba(15,23,42,0.9), transparent 55%),
        radial-gradient(circle at bottom right, rgba(8,47,73,0.65), transparent 55%),
        linear-gradient(180deg, #020617, #020617 40%, #030712);
      padding: 10px 14px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .right-columns {
      display: flex;
      min-width: 0;
      background:
        radial-gradient(circle at top left, rgba(30,64,175,0.25), transparent 55%),
        radial-gradient(circle at bottom right, rgba(15,23,42,0.9), transparent 60%),
        #020617;
    }

    .detail-column {
      flex: 0 0 var(--detail-initial-width);
      max-width: 75%;
      min-width: 320px;
      padding: 12px 16px 14px;
      border-right: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .map-pane {
      flex: 1 1 auto;
      position: relative;
      background: radial-gradient(circle at top, #020617 0, #000 52%);
    }

    #map {
      position: absolute;
      inset: 0;
    }

    .drag-handle {
      width: 6px;
      cursor: col-resize;
      background: linear-gradient(180deg, #020617, #020617);
      border-left: 1px solid rgba(15,23,42,0.9);
      border-right: 1px solid rgba(30,64,175,0.55);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .drag-handle::before {
      content: "";
      width: 2px;
      height: 40px;
      border-radius: 999px;
      background: linear-gradient(180deg, #64748b, #e2e8f0);
      opacity: 0.6;
    }

    .drag-handle.dragging {
      background: radial-gradient(circle at center, rgba(59,130,246,0.22), #020617);
    }

    @media (max-width: 1100px) {
      main {
        grid-template-columns: minmax(240px, 300px) minmax(0, 1.8fr);
        grid-template-rows: minmax(320px, 1fr);
      }
      .right-columns {
        flex-direction: column;
      }
      .detail-column {
        max-width: 100%;
        min-width: 0;
        border-right: none;
        border-bottom: 1px solid var(--border-subtle);
      }
      .drag-handle {
        display: none;
      }
      .map-pane {
        min-height: 260px;
      }
    }

    @media (max-width: 780px) {
      main {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto;
      }
      .sidebar {
        border-right: none;
        border-bottom: 1px solid var(--border-subtle);
      }
      .map-pane {
        display: none;
      }
    }

    .btn {
      border: 1px solid var(--border-strong);
      background: radial-gradient(circle at top left, #172554 0, #020617 65%);
      color: var(--text);
      font-size: 12px;
      line-height: 1.3;
      padding: 6px 12px;
      border-radius: var(--radius-pill);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.9);
      transition: 0.15s transform ease, 0.15s box-shadow ease, 0.15s background ease;
      white-space: nowrap;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 38px rgba(15, 23, 42, 0.95);
      background: radial-gradient(circle at top left, #1e3a8a 0, #020617 65%);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.95);
    }

    .btn-ghost {
      background: transparent;
      border-style: dashed;
      border-color: #334155;
      box-shadow: none;
      color: var(--muted);
    }

    .btn-ghost:hover {
      background: rgba(15,23,42,0.8);
      color: var(--text);
    }

    .btn-xs {
      font-size: 11px;
      padding: 3px 8px;
      box-shadow: none;
    }

    .panel {
      background: radial-gradient(circle at top left, rgba(30,64,175,0.45), transparent 55%), #020617;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      padding: 10px 10px;
      margin-bottom: 10px;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
      gap: 8px;
    }

    .panel-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #bfdbfe;
    }

    .panel-subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .days-list {
      max-height: calc(100vh - 180px);
      overflow: auto;
      padding-right: 4px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .day-card {
      background: radial-gradient(circle at top left, rgba(37,99,235,0.18), transparent 55%), #020617;
      border-radius: var(--radius-md);
      border: 1px solid #1f2937;
      padding: 8px 8px 7px;
      cursor: pointer;
      transition: 0.15s border, 0.15s box-shadow, 0.15s transform;
      position: relative;
    }

    .day-card:hover {
      border-color: #3b82f6;
      box-shadow: 0 12px 30px rgba(15,23,42,0.9);
      transform: translateY(-1px);
    }

    .day-card.active {
      border-color: #7bd3ff;
      box-shadow: 0 0 0 1px rgba(123,211,255,0.3);
    }

    .day-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 3px;
    }

    .day-title {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pill {
      font-size: 11px;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      color: var(--muted);
    }

    .day-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
      color: var(--muted);
    }

    .day-notes {
      font-size: 12px;
      color: var(--muted);
      margin-top: 3px;
    }

    .day-notes strong {
      color: #e5e7eb;
    }

    .detail-panel {
      margin-top: 4px;
      padding: 12px 14px;
      border-radius: var(--radius-md);
      border: 1px dashed rgba(148,163,184,0.4);
      background: radial-gradient(circle at top left, rgba(30,64,175,0.16), transparent 60%);
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 460px;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: 1.1fr 1.1fr;
      gap: 12px;
    }

    @media (max-width: 900px) {
      .detail-grid {
        grid-template-columns: 1fr;
      }
    }

    .field-group label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 2px;
      display: block;
    }

    input[type="text"],
    input[type="number"],
    textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: linear-gradient(135deg, #020617, #020617);
      color: var(--text);
      font-family: inherit;
      font-size: 13px;
      padding: 6px 8px;
      outline: none;
      transition: 0.15s border, 0.15s box-shadow, 0.15s background;
    }

    textarea {
      resize: vertical;
      min-height: 64px;
    }

    input:focus,
    textarea:focus {
      border-color: #7bd3ff;
      box-shadow: 0 0 0 1px rgba(123,211,255,0.4);
      background: #020617;
    }

    .two-cols {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .small {
      font-size: 11px;
      color: var(--muted);
    }

    .muted {
      color: var(--muted);
    }

    .routes-list {
      max-height: 180px;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top left, rgba(15,23,42,0.9), transparent 60%);
    }

    .route-row {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 6px;
      align-items: center;
      padding: 5px 8px;
      font-size: 12px;
      color: var(--muted);
      border-bottom: 1px solid rgba(15,23,42,0.85);
    }

    .route-row:last-child {
      border-bottom: none;
    }

    .route-badge {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
    }

    .route-meta {
      font-size: 11px;
      color: var(--muted);
    }

    .mt-1 { margin-top: 4px; }
    .mt-2 { margin-top: 8px; }
    .mt-3 { margin-top: 12px; }

    .pill-secondary {
      font-size: 11px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.2);
      color: var(--muted);
      background: rgba(15,23,42,0.7);
    }

    .callout {
      border-radius: 12px;
      border: 1px solid rgba(59,130,246,0.4);
      background: radial-gradient(circle at top left, rgba(37,99,235,0.2), transparent 60%);
      padding: 6px 8px;
      font-size: 11px;
      color: var(--muted);
      display: flex;
      gap: 8px;
    }

    .callout strong {
      color: #dbeafe;
    }

    .callout-icon {
      font-size: 14px;
      margin-top: 1px;
    }

    .hint {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    .stop-row {
      display: grid;
      grid-template-columns: auto 1.8fr auto auto;
      gap: 6px;
      align-items: center;
      padding: 5px 8px;
      font-size: 12px;
      color: var(--muted);
      border-bottom: 1px solid rgba(15,23,42,0.85);
    }

    .stop-row:last-child {
      border-bottom: none;
    }

    .stop-name-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
      padding: 3px 7px;
    }

    .stop-btn {
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 11px;
      padding: 3px 7px;
      cursor: pointer;
    }

    .stop-btn:hover {
      background: rgba(30,64,175,0.85);
    }

    .stop-delete-btn {
      border-radius: 999px;
      border: 1px solid rgba(248,113,113,0.7);
      background: rgba(127,29,29,0.6);
      color: #fecaca;
      font-size: 11px;
      padding: 2px 6px;
      cursor: pointer;
    }

    .stop-delete-btn:hover {
      background: rgba(127,29,29,0.9);
    }
  </style>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
<script src="auth.js"></script>
<script>requireAuth();</script>

<div class="app-shell">
  <header>
    <div class="header-left">
      <h1 id="pageTitle">Voyage</h1>
      <div class="subtitle">Planning d√©taill√©, trajets et notes par jour. Modifiable et sauvegard√© dans ton navigateur.</div>
    </div>
    <div class="toolbar">
      <button id="exportTrip" class="btn">‚Ü• Export JSON</button>
      <button id="importTrip" class="btn btn-ghost">‚Üß Import JSON</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none">
    </div>
  </header>

  <main>
    <aside class="sidebar">
      <section class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">Jours du voyage</div>
            <div class="panel-subtitle">Clique sur un jour pour √©diter le d√©tail.</div>
          </div>
          <button id="addDay" class="btn btn-ghost">+ Jour</button>
        </div>
        <div id="daysList" class="days-list"></div>
      </section>
    </aside>

    <div class="right-columns">
      <section class="detail-column">
        <section class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">D√©tail du jour</div>
              <div class="panel-subtitle">√âtapes, trajet GPS et budget pour le jour s√©lectionn√©.</div>
            </div>
          </div>

          <div id="dayDetail" class="detail-panel">
            <div class="small muted">S√©lectionne un jour dans la liste √† gauche.</div>
          </div>
        </section>
      </section>

      <div id="dragHandle" class="drag-handle"></div>

      <section class="map-pane">
        <div id="map"></div>
      </section>
    </div>
  </main>
</div>


<script>
const HOME = { lat: 47.0087, lng: 6.9556 };
const CAR = {
  consumptionLPer100km: 8,
  fuelPricePerL: 1.9
};

(function initTitleAndKeys(){
  const parts = window.location.pathname.split('/').filter(Boolean);
  let year = "XXXX";
  let slug = "voyage";
  if (parts.length >= 2) {
    year = parts[parts.length - 2];
    let filename = parts[parts.length - 1] || "";
    slug = filename.replace(/\.html$/i, "") || "voyage";
  }

  const niceName = slug
    .split('-')
    .filter(Boolean)
    .map(w => w.charAt(0).toUpperCase() + w.slice(1))
    .join(' ');

  const title = `${niceName} ‚Äî ${year}`;
  document.title = title;
  const headerTitleEl = document.getElementById('pageTitle');
  if (headerTitleEl) headerTitleEl.textContent = title;

  window.__TRIP_YEAR__ = year;
  window.__TRIP_SLUG__ = slug;
})();

const tripYear = window.__TRIP_YEAR__ || "XXXX";
const tripSlug = window.__TRIP_SLUG__ || "voyage";

const STORE_KEY = `trip.${tripYear}.${tripSlug}.v2`;
const META_KEY  = `trip.${tripYear}.${tripSlug}.meta.v2`;

const OVERVIEW_ID = "__overview__";

let days = [];
let meta = { lastSelectedDayId: OVERVIEW_ID };

/* ---------- utils ---------- */

function $(sel){ return document.querySelector(sel); }
function createElem(tag, className, html) {
  const el = document.createElement(tag);
  if (className) el.className = className;
  if (html !== undefined) el.innerHTML = html;
  return el;
}
function formatKm(km) { return (km == null || km === "") ? "‚Äî" : `${Math.round(km)} km`; }
function formatHours(h) { return (h == null || h === "") ? "‚Äî" : `${Number(h).toFixed(1)} h`; }
function formatCHF(x) { return (x == null || x === "") ? "‚Äî" : `${Number(x).toFixed(0)} CHF`; }
function ensureDayId(){ return 'd_' + Math.random().toString(36).slice(2, 10); }
function ensureStopId(){ return 's_' + Math.random().toString(36).slice(2, 10); }
function ensureFileId(){ return 'f_' + Math.random().toString(36).slice(2, 10); }
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

function normalizeDay(d){
  if (!d.id) d.id = ensureDayId();
  if (!Array.isArray(d.stops)) d.stops = [];
  if (!d.route) d.route = null;

  // NEW: d√©penses par cat√©gories
  if (d.costActivities == null) d.costActivities = null;
  if (d.costLodging == null) d.costLodging = null;
  if (d.costFood == null) d.costFood = null;
  if (d.costOther == null) d.costOther = null;

  // NEW: logement (cat√©gorie descriptive)
  if (!d.lodging) d.lodging = { name:"", address:"", checkin:"", checkout:"", notes:"" };

  // gestion auto-budget
  if (typeof d.budgetAuto !== "boolean") d.budgetAuto = true;

  return d;
}

function fuelEstimateForKm(km){
  if (km == null || km === "" || !Number.isFinite(Number(km))) return { liters: null, cost: null };
  const liters = Number(km) * CAR.consumptionLPer100km / 100;
  const cost = liters * CAR.fuelPricePerL;
  return { liters, cost };
}

function computeTotalBudget(day){
  const km = day.km;
  const { cost: fuelCost } = fuelEstimateForKm(km);
  const a = Number(day.costActivities || 0);
  const l = Number(day.costLodging || 0);
  const f = Number(day.costFood || 0);
  const o = Number(day.costOther || 0);
  const total = (fuelCost || 0) + a + l + f + o;
  return { total, fuelCost };
}

/* ---------- persistence ---------- */

function loadState() {
  try {
    const raw = localStorage.getItem(STORE_KEY);
    const metaRaw = localStorage.getItem(META_KEY);

    if (raw) {
      days = JSON.parse(raw);
      if (!Array.isArray(days)) days = [];
    } else {
      days = [];
    }

    days = days.map(normalizeDay);

    if (metaRaw) meta = Object.assign(meta, JSON.parse(metaRaw) || {});
  } catch (e) {
    console.warn("Erreur stockage", e);
    days = [];
  }
}

function saveState() {
  localStorage.setItem(STORE_KEY, JSON.stringify(days));
  localStorage.setItem(META_KEY, JSON.stringify(meta));
}

/* ---------- MAP ---------- */

let map;
let routesLayer;

function initMap() {
  const mapEl = document.getElementById('map');
  if (!mapEl) return;
  map = L.map('map', { zoomControl: true });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);
  map.setView([HOME.lat, HOME.lng], 5);
  routesLayer = L.layerGroup().addTo(map);
}

function clearMap() {
  if (routesLayer) routesLayer.clearLayers();
}

function drawRoutesForOverview() {
  if (!map || !routesLayer) return;
  clearMap();

  const bounds = [];
  const colors = ["#38bdf8", "#22c55e", "#f97316", "#a78bfa", "#facc15", "#fb7185", "#60a5fa", "#34d399"];

  days.forEach((day, i) => {
    let coords = [];
    if (day.route && Array.isArray(day.route.geometry)) {
      coords = day.route.geometry.map(c => [c[1], c[0]]);
    } else if (Array.isArray(day.stops)) {
      const pts = day.stops.filter(s => typeof s.lat === "number" && typeof s.lng === "number");
      if (pts.length >= 2) coords = pts.map(s => [s.lat, s.lng]);
    }
    if (!coords.length) return;

    const color = colors[i % colors.length];
    const pl = L.polyline(coords, { color, weight: 3, opacity: 0.85 }).addTo(routesLayer);
    pl.bindTooltip(day.label || `Jour ${i+1}`, { sticky: true });

    coords.forEach((p, idx) => {
      const c = idx === 0 ? "#22c55e" : (idx === coords.length - 1 ? "#f97316" : "#64748b");
      L.circleMarker(p, { radius: 3.5, color: c, weight: 2, opacity: 0.9 }).addTo(routesLayer);
      bounds.push(p);
    });
  });

  if (bounds.length) {
    map.fitBounds(bounds, { padding: [40, 40] });
  } else {
    map.setView([HOME.lat, HOME.lng], 5);
  }
}

function drawRoutesForDay(day) {
  if (!map || !routesLayer) return;

  if (selectedDayId === OVERVIEW_ID) {
    drawRoutesForOverview();
    return;
  }

  clearMap();

  if (!day) {
    map.setView([HOME.lat, HOME.lng], 5);
    return;
  }

  let coords = [];
  if (day.route && Array.isArray(day.route.geometry)) {
    coords = day.route.geometry.map(c => [c[1], c[0]]);
  } else if (Array.isArray(day.stops)) {
    const pts = day.stops.filter(s => typeof s.lat === "number" && typeof s.lng === "number");
    if (pts.length >= 2) coords = pts.map(s => [s.lat, s.lng]);
  }

  if (!coords.length) {
    map.setView([HOME.lat, HOME.lng], 5);
    return;
  }

  const pl = L.polyline(coords, { color: "#38bdf8", weight: 3, opacity: 0.9 });
  pl.addTo(routesLayer);

  coords.forEach((p, i) => {
    const color = i === 0 ? "#22c55e" : (i === coords.length - 1 ? "#f97316" : "#64748b");
    L.circleMarker(p, { radius: 4, color, weight: 2 }).addTo(routesLayer);
  });

  map.fitBounds(coords, { padding: [40, 40] });
}

/* ---------- GEOCODING + ROUTING ---------- */

const geoCache = {};

async function geocodePlace(name) {
  const trimmed = (name || "").trim();
  if (!trimmed) return null;
  if (geoCache[trimmed]) return geoCache[trimmed];
  try {
    const url = "https://nominatim.openstreetmap.org/search?format=json&q=" +
      encodeURIComponent(trimmed);
    const res = await fetch(url, {
      headers: { "Accept-Language": "fr" }
    });
    const data = await res.json();
    if (Array.isArray(data) && data.length > 0) {
      const { lat, lon } = data[0];
      const pt = { lat: parseFloat(lat), lng: parseFloat(lon) };
      geoCache[trimmed] = pt;
      return pt;
    }
  } catch (e) {
    console.warn("Erreur geocode", trimmed, e);
  }
  return null;
}

async function computeRouteForDay(day) {
  if (!Array.isArray(day.stops)) day.stops = [];
  const validStops = day.stops.filter(s => typeof s.lat === "number" && typeof s.lng === "number");
  if (validStops.length < 2) {
    day.route = null;
    return;
  }

  const coordsStr = validStops
    .map(s => `${s.lng.toFixed(6)},${s.lat.toFixed(6)}`)
    .join(";");

  const url = `https://router.project-osrm.org/route/v1/driving/${coordsStr}?overview=full&geometries=geojson`;

  try {
    const res = await fetch(url);
    const data = await res.json();
    if (!data.routes || !data.routes.length) {
      console.warn("Pas de route trouv√©e");
      return;
    }
    const route = data.routes[0];
    const distanceKm = route.distance / 1000;
    const durationH = route.duration / 3600;

    day.route = {
      distanceKm: distanceKm,
      durationH: durationH,
      geometry: route.geometry.coordinates
    };

    // auto-fill km/h si vide
    if (day.km == null) day.km = Math.round(distanceKm);
    if (day.driveHours == null) day.driveHours = Number(durationH.toFixed(1));

    // auto-update budget total si mode auto
    if (day.budgetAuto) {
      const { total } = computeTotalBudget(day);
      day.budget = Math.round(total);
    }
  } catch (e) {
    console.warn("Erreur OSRM", e);
  }
}

/* ---------- STATE HELPERS ---------- */

let selectedDayId = OVERVIEW_ID;

function getSelectedDay() {
  return days.find(d => d.id === selectedDayId) || null;
}

function selectDay(id){
  selectedDayId = id;
  meta.lastSelectedDayId = id;
  saveState();
  renderDaysList();
  renderDayDetail();
  drawRoutesForDay(getSelectedDay());
}

/* ---------- SIDEBAR ---------- */

function renderDaysList() {
  const container = $("#daysList");
  container.innerHTML = "";

  // Overview card always on top
  const overview = createElem("div", "day-card" + (selectedDayId === OVERVIEW_ID ? " active" : ""));
  overview.innerHTML = `
    <div class="day-header">
      <div class="day-title"><span class="pill">‚òÖ</span><span>R√©capitulatif</span></div>
    </div>
    <div class="day-meta">Carte globale ¬∑ Totaux km / heures / d√©penses ¬∑ Acc√®s rapide</div>
    <div class="day-notes">Vue d‚Äôensemble du trip (avant les jours).</div>
  `;
  overview.addEventListener("click", ()=>selectDay(OVERVIEW_ID));
  container.appendChild(overview);

  if (!days.length) {
    const empty = createElem("div", "small muted", "Aucun jour d√©fini pour l‚Äôinstant. Ajoute ton premier jour !");
    empty.style.marginTop = "8px";
    container.appendChild(empty);
    return;
  }

  days.forEach((day, idx) => {
    const card = createElem("div", "day-card" + (day.id === selectedDayId ? " active" : ""));
    const header = createElem("div", "day-header");
    const title = createElem("div", "day-title");
    const badge = createElem("span", "pill", `J${idx + 1}`);
    const text = createElem("span", "", day.label || `Jour ${idx + 1}`);
    title.appendChild(badge);
    title.appendChild(text);

    const metaRow = createElem("div", "day-meta");
    const parts = [];
    if (day.date) parts.push(`üìÖ ${day.date}`);
    if (day.start || day.end) parts.push(`üìç ${day.start || "?"} ‚Üí ${day.end || "?"}`);
    if (day.km != null) parts.push(`üõ£Ô∏è ${formatKm(day.km)}`);
    if (day.driveHours != null) parts.push(`‚è± ${formatHours(day.driveHours)}`);
    if (day.budget != null) parts.push(`üí∏ ${formatCHF(day.budget)}`);
    metaRow.textContent = parts.join(" ¬∑ ");

    const notes = createElem("div", "day-notes");
    if (day.summary) {
      notes.innerHTML = `<strong>${day.summary}</strong>` + (day.notes ? ` ‚Äî ${day.notes}` : "");
    } else if (day.notes) {
      notes.textContent = day.notes;
    } else {
      notes.textContent = "Aucune note pour l‚Äôinstant.";
    }

    header.appendChild(title);
    card.appendChild(header);
    card.appendChild(metaRow);
    card.appendChild(notes);

    card.addEventListener("click", () => selectDay(day.id));
    container.appendChild(card);
  });
}

/* ---------- STOPS ---------- */

function renderStopsList(day, wrapper) {
  const list = createElem("div", "routes-list");

  const headerRow = createElem("div", "stop-row");
  headerRow.innerHTML = `
    <div class="route-badge">#</div>
    <div class="small">√âtape (ville / lieu)</div>
    <div></div>
    <div></div>
  `;
  list.appendChild(headerRow);

  if (!Array.isArray(day.stops)) day.stops = [];

  if (!day.stops.length) {
    const empty = createElem("div", "small muted", "Ajoute des √©tapes comme sur un GPS (Neuch√¢tel, Walibi Holland, Farup Sommerland‚Ä¶).");
    empty.style.padding = "6px 8px";
    list.appendChild(empty);
    wrapper.appendChild(list);
    return;
  }

  day.stops.forEach((stop, idx) => {
    const row = createElem("div", "stop-row");
    const idxSpan = createElem("div", "route-badge", `${idx + 1}`);

    const nameInput = document.createElement("input");
    nameInput.type = "text";
    nameInput.className = "stop-name-input";
    nameInput.value = stop.name || "";
    nameInput.placeholder = "Ville / lieu";

    const geoBtn = createElem("button", "stop-btn", "üìç");
    geoBtn.title = "Rechercher sur la carte";

    const delBtn = createElem("button", "stop-delete-btn", "‚úï");

    async function updateStopPosition() {
      const name = (stop.name || "").trim();
      if (!name) return;
      const pt = await geocodePlace(name);
      if (!pt) {
        alert("Lieu introuvable pour : " + name);
        return;
      }
      stop.lat = pt.lat;
      stop.lng = pt.lng;
      saveState();
      await computeRouteForDay(day);
      saveState();
      renderDaysList();
      renderDayDetail();
      drawRoutesForDay(day);
    }

    nameInput.addEventListener("input", () => {
      stop.name = nameInput.value;
      saveState();
    });

    nameInput.addEventListener("blur", () => {
      if (nameInput.value.trim().length > 2) updateStopPosition();
    });

    geoBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      updateStopPosition();
    });

    delBtn.addEventListener("click", async (e) => {
      e.stopPropagation();
      const index = day.stops.indexOf(stop);
      if (index >= 0) {
        day.stops.splice(index, 1);
        saveState();
        await computeRouteForDay(day);
        saveState();
        renderDayDetail();
        renderDaysList();
        drawRoutesForDay(day);
      }
    });

    row.appendChild(idxSpan);
    row.appendChild(nameInput);
    row.appendChild(geoBtn);
    row.appendChild(delBtn);
    list.appendChild(row);
  });

  wrapper.appendChild(list);
}

function renderRoutesSummary(day, wrapper) {
  const list = createElem("div", "routes-list");
  if (!Array.isArray(day.stops) || !day.stops.length) {
    const empty = createElem("div", "small muted", "Aucun trajet d√©fini pour ce jour.");
    empty.style.padding = "6px 8px";
    list.appendChild(empty);
    wrapper.appendChild(list);
    return;
  }

  day.stops.forEach((stop, idx) => {
    const row = createElem("div", "route-row");
    const idxSpan = createElem("div", "route-badge", `${idx + 1}`);
    const main = createElem("div", "");
    const label = stop.name || "(√©tape sans nom)";
    const title = createElem("div", "", label);
    title.style.fontSize = "12px";
    title.style.color = "#e5e7eb";

    const meta = createElem("div", "route-meta");
    if (typeof stop.lat === "number" && typeof stop.lng === "number") {
      meta.textContent = `Lat: ${stop.lat.toFixed(4)} ¬∑ Lng: ${stop.lng.toFixed(4)}`;
    } else {
      meta.textContent = "Non g√©olocalis√©";
    }

    main.appendChild(title);
    main.appendChild(meta);

    const typeBadge = createElem("div", "pill-secondary", idx === 0 ? "D√©part" : "√âtape");
    row.appendChild(idxSpan);
    row.appendChild(main);
    row.appendChild(typeBadge);
    list.appendChild(row);
  });

  wrapper.appendChild(list);
}

/* ---------- "DOSSIER" (IndexedDB) ---------- */

const DB_NAME = `tripFiles.${tripYear}.${tripSlug}.v1`;
const DB_STORE = "files";

function openFilesDB(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = (e)=>{
      const db = req.result;
      if(!db.objectStoreNames.contains(DB_STORE)){
        const store = db.createObjectStore(DB_STORE, { keyPath: "id" });
        store.createIndex("dayId", "dayId", { unique: false });
      }
    };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
}

async function addFilesForDay(dayId, fileList){
  const files = Array.from(fileList || []);
  if(!files.length) return;

  const db = await openFilesDB();
  await new Promise((resolve, reject)=>{
    const tx = db.transaction(DB_STORE, "readwrite");
    const store = tx.objectStore(DB_STORE);
    files.forEach(file=>{
      const rec = {
        id: ensureFileId(),
        dayId,
        name: file.name,
        type: file.type || "application/octet-stream",
        size: file.size,
        lastModified: file.lastModified,
        blob: file
      };
      store.put(rec);
    });
    tx.oncomplete = ()=> resolve();
    tx.onerror = ()=> reject(tx.error);
  });
  db.close();
}

async function listFilesForDay(dayId){
  const db = await openFilesDB();
  const out = await new Promise((resolve, reject)=>{
    const tx = db.transaction(DB_STORE, "readonly");
    const store = tx.objectStore(DB_STORE);
    const idx = store.index("dayId");
    const req = idx.getAll(dayId);
    req.onsuccess = ()=> resolve(req.result || []);
    req.onerror = ()=> reject(req.error);
  });
  db.close();
  // tri: dernier modifi√© d'abord
  out.sort((a,b)=>(b.lastModified||0)-(a.lastModified||0));
  return out;
}

async function deleteFile(fileId){
  const db = await openFilesDB();
  await new Promise((resolve, reject)=>{
    const tx = db.transaction(DB_STORE, "readwrite");
    const store = tx.objectStore(DB_STORE);
    store.delete(fileId);
    tx.oncomplete = ()=> resolve();
    tx.onerror = ()=> reject(tx.error);
  });
  db.close();
}

function downloadBlob(name, blob){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = name || "download";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 5000);
}

/* ---------- OVERVIEW DETAIL ---------- */

function computeTripTotals(){
  let totalKm = 0;
  let totalH = 0;
  let totalBudget = 0;
  let totalFuel = 0;
  let totalAct = 0;
  let totalLodg = 0;
  let totalFood = 0;
  let totalOther = 0;

  days.forEach(d=>{
    if (Number.isFinite(Number(d.km))) totalKm += Number(d.km);
    if (Number.isFinite(Number(d.driveHours))) totalH += Number(d.driveHours);

    const { fuelCost, total } = computeTotalBudget(d);
    totalFuel += (fuelCost || 0);
    totalAct  += Number(d.costActivities || 0);
    totalLodg += Number(d.costLodging || 0);
    totalFood += Number(d.costFood || 0);
    totalOther += Number(d.costOther || 0);

    if (Number.isFinite(Number(d.budget))) totalBudget += Number(d.budget);
    else totalBudget += total; // fallback
  });

  return {
    totalKm, totalH,
    totalBudget,
    breakdown: { fuel: totalFuel, activities: totalAct, lodging: totalLodg, food: totalFood, other: totalOther }
  };
}

function renderOverviewDetail(container){
  const totals = computeTripTotals();

  const top = createElem("div", "field-group");
  top.innerHTML = `
    <label>Vue r√©capitulative du voyage</label>
    <div class="callout mt-1">
      <div class="callout-icon">üß≠</div>
      <div>
        <strong>Carte globale</strong> ‚Äî Tous les trajets de tous les jours sont affich√©s √† droite.
        <div class="hint">Astuce : calcule au moins 2 √©tapes par jour pour voir une ligne.</div>
      </div>
    </div>
  `;

  const grid = createElem("div", "detail-grid mt-2");

  const col1 = createElem("div", "col");
  col1.appendChild(createElem("div", "field-group", `
    <label>Chiffres globaux</label>
    <div class="two-cols">
      <div class="panel" style="padding:10px;border-radius:12px">
        <div class="small muted">Distance totale</div>
        <div style="font-size:18px;font-weight:700">${formatKm(totals.totalKm)}</div>
      </div>
      <div class="panel" style="padding:10px;border-radius:12px">
        <div class="small muted">Heures de route</div>
        <div style="font-size:18px;font-weight:700">${formatHours(totals.totalH)}</div>
      </div>
    </div>
    <div class="two-cols mt-2">
      <div class="panel" style="padding:10px;border-radius:12px">
        <div class="small muted">D√©penses totales</div>
        <div style="font-size:18px;font-weight:700">${formatCHF(totals.totalBudget)}</div>
      </div>
      <div class="panel" style="padding:10px;border-radius:12px">
        <div class="small muted">Carburant estim√©</div>
        <div style="font-size:18px;font-weight:700">${formatCHF(totals.breakdown.fuel)}</div>
      </div>
    </div>
  `));

  const breakdown = createElem("div", "field-group mt-2");
  breakdown.innerHTML = `
    <label>R√©partition (cat√©gories)</label>
    <div class="routes-list">
      <div class="route-row"><div class="route-badge">‚õΩ</div><div>Carburant (estim.)</div><div>${formatCHF(totals.breakdown.fuel)}</div></div>
      <div class="route-row"><div class="route-badge">üéüÔ∏è</div><div>Activit√©s</div><div>${formatCHF(totals.breakdown.activities)}</div></div>
      <div class="route-row"><div class="route-badge">üè®</div><div>Nourriture</div><div>${formatCHF(totals.breakdown.food)}</div></div>
      <div class="route-row"><div class="route-badge">üõèÔ∏è</div><div>Logement</div><div>${formatCHF(totals.breakdown.lodging)}</div></div>
      <div class="route-row"><div class="route-badge">‚ûï</div><div>Autre</div><div>${formatCHF(totals.breakdown.other)}</div></div>
    </div>
    <div class="hint">Les fichiers du "dossier" ne sont pas inclus dans l‚Äôexport JSON (ils sont stock√©s dans ton navigateur via IndexedDB).</div>
  `;
  col1.appendChild(breakdown);

  const col2 = createElem("div", "col");
  const perDay = createElem("div", "field-group");
  perDay.innerHTML = `<label>Totaux par jour</label>`;
  const list = createElem("div", "routes-list");
  if(!days.length){
    list.appendChild(createElem("div", "small muted", "Ajoute des jours pour voir le r√©cap."));
    list.firstChild.style.padding = "6px 8px";
  }else{
    days.forEach((d, i)=>{
      const { fuelCost, total } = computeTotalBudget(d);
      const row = createElem("div", "route-row");
      row.style.cursor = "pointer";
      row.innerHTML = `
        <div class="route-badge">J${i+1}</div>
        <div>
          <div style="color:#e5e7eb">${d.label || `Jour ${i+1}`}</div>
          <div class="route-meta">${(d.start||"?")} ‚Üí ${(d.end||"?")} ¬∑ ${formatKm(d.km)} ¬∑ ${formatHours(d.driveHours)}</div>
        </div>
        <div>${formatCHF(d.budget != null ? d.budget : total)}</div>
      `;
      row.addEventListener("click", ()=>selectDay(d.id));
      list.appendChild(row);
    });
  }
  perDay.appendChild(list);
  col2.appendChild(perDay);

  grid.appendChild(col1);
  grid.appendChild(col2);

  container.appendChild(top);
  container.appendChild(grid);
}

/* ---------- DAY DETAIL ---------- */

function renderDayDetail() {
  const container = $("#dayDetail");
  container.innerHTML = "";

  if (selectedDayId === OVERVIEW_ID) {
    renderOverviewDetail(container);
    return;
  }

  const day = getSelectedDay();
  if (!day) {
    const msg = createElem("div", "small muted", "S√©lectionne un jour dans la liste de gauche pour afficher les d√©tails.");
    container.appendChild(msg);
    return;
  }
  normalizeDay(day);

  const grid = createElem("div", "detail-grid");

  const col1 = createElem("div", "col");

  col1.appendChild(createElem("div", "field-group", `
    <label>Titre du jour</label>
    <input type="text" id="dayLabel" value="${day.label || ""}">
  `));

  col1.appendChild(createElem("div", "field-group mt-2", `
    <label>Date (optionnelle)</label>
    <input type="text" id="dayDate" placeholder="ex: 12 juillet" value="${day.date || ""}">
  `));

  col1.appendChild(createElem("div", "field-group mt-2", `
    <label>√âtapes principales (libre)</label>
    <div class="two-cols">
      <input type="text" id="dayStart" placeholder="D√©part logique" value="${day.start || ""}">
      <input type="text" id="dayEnd" placeholder="Arriv√©e logique" value="${day.end || ""}">
    </div>
  `));

  col1.appendChild(createElem("div", "field-group mt-2", `
    <label>R√©sum√© rapide</label>
    <input type="text" id="daySummary" placeholder="ex: Parc + route c√¥ti√®re + camping" value="${day.summary || ""}">
  `));

  col1.appendChild(createElem("div", "field-group mt-2", `
    <label>Notes d√©taill√©es</label>
    <textarea id="dayNotes" placeholder="D√©tails, spots, restos, contraintes horaires‚Ä¶">${day.notes || ""}</textarea>
  `));

  // NEW: Logement (cat√©gorie descriptive)
  col1.appendChild(createElem("div", "field-group mt-2", `
    <label>Logement (infos)</label>
    <input type="text" id="lodgingName" placeholder="Nom / type (hotel, camping...)" value="${day.lodging?.name || ""}">
    <div class="two-cols mt-1">
      <input type="text" id="lodgingCheckin" placeholder="Check-in" value="${day.lodging?.checkin || ""}">
      <input type="text" id="lodgingCheckout" placeholder="Check-out" value="${day.lodging?.checkout || ""}">
    </div>
    <div class="mt-1">
      <input type="text" id="lodgingAddress" placeholder="Adresse / lien Google Maps" value="${day.lodging?.address || ""}">
    </div>
    <div class="mt-1">
      <textarea id="lodgingNotes" placeholder="Notes logement (parking, code porte, etc.)">${day.lodging?.notes || ""}</textarea>
    </div>
  `));

  const col2 = createElem("div", "col");

  // chiffres cl√©s
  const fgNumbers = createElem("div", "field-group");
  fgNumbers.innerHTML = `<label>Chiffres cl√©s</label>`;

  const hoursGroup = createElem("div", "field-group mt-1");
  hoursGroup.innerHTML = `
    <label>Heures de route (manuel)</label>
    <input type="number" id="dayDriveHours" placeholder="heures de route" step="0.5" value="${day.driveHours ?? ""}">
  `;
  const autoHoursHint = createElem("div", "hint");
  if (day.route && typeof day.route.durationH === "number") {
    autoHoursHint.textContent = `Temps GPS estim√© : ${day.route.durationH.toFixed(1)} h`;
  } else {
    autoHoursHint.textContent = "Temps GPS estim√© disponible apr√®s calcul du trajet.";
  }
  hoursGroup.appendChild(autoHoursHint);

  const kmGroup = createElem("div", "field-group mt-2");
  kmGroup.innerHTML = `
    <label>Distance totale (km)</label>
    <input type="number" id="dayKm" placeholder="km (manuel)" step="1" value="${day.km ?? ""}">
  `;
  const autoKmHint = createElem("div", "hint");
  if (day.route && typeof day.route.distanceKm === "number") {
    autoKmHint.textContent = `Trajet GPS estim√© : ${Math.round(day.route.distanceKm)} km`;
  } else {
    autoKmHint.textContent = "Distance GPS estim√©e apr√®s calcul du trajet.";
  }
  kmGroup.appendChild(autoKmHint);

  // NEW: d√©penses par cat√©gorie
  const expGroup = createElem("div", "field-group mt-2");
  const { liters, cost: fuelCost } = fuelEstimateForKm(day.km);
  const { total: computedTotal } = computeTotalBudget(day);
  expGroup.innerHTML = `
    <label>D√©penses (CHF)</label>
    <div class="two-cols">
      <div class="field-group">
        <label>Activit√©s</label>
        <input type="number" id="costActivities" placeholder="0" value="${day.costActivities ?? ""}">
      </div>
      <div class="field-group">
        <label>Nourriture</label>
        <input type="number" id="costFood" placeholder="0" value="${day.costFood ?? ""}">
      </div>
    </div>
    <div class="two-cols mt-1">
      <div class="field-group">
        <label>Logement</label>
        <input type="number" id="costLodging" placeholder="0" value="${day.costLodging ?? ""}">
      </div>
      <div class="field-group">
        <label>Autre</label>
        <input type="number" id="costOther" placeholder="0" value="${day.costOther ?? ""}">
      </div>
    </div>
  `;
  const expHint = createElem("div", "hint");
  expHint.textContent = (liters != null)
    ? `Carburant estim√© : ${liters.toFixed(1)} L (~${fuelCost.toFixed(1)} CHF). Total estim√© (carburant + cat√©gories) : ${computedTotal.toFixed(0)} CHF.`
    : `Renseigne une distance (km) pour estimer le carburant et le total.`;
  expGroup.appendChild(expHint);

  const budgetGroup = createElem("div", "field-group mt-2");
  budgetGroup.innerHTML = `
    <label>Budget total (CHF)</label>
    <input type="number" id="dayBudget" placeholder="Total (CHF)" value="${day.budget ?? ""}">
  `;
  const budgetHint = createElem("div", "hint");
  budgetHint.textContent = day.budgetAuto
    ? `Mode auto : le budget total suit l'estimation (carburant + cat√©gories).`
    : `Mode manuel : tu as override le total.`;
  const budgetAutoToggle = createElem("button", "btn btn-ghost btn-xs mt-1", day.budgetAuto ? "üîí Auto" : "üîì Manuel");
  budgetAutoToggle.addEventListener("click", ()=>{
    day.budgetAuto = !day.budgetAuto;
    if(day.budgetAuto){
      const { total } = computeTotalBudget(day);
      day.budget = Math.round(total);
    }
    saveState();
    renderDayDetail();
    renderDaysList();
  });
  budgetGroup.appendChild(budgetHint);
  budgetGroup.appendChild(budgetAutoToggle);

  fgNumbers.appendChild(hoursGroup);
  fgNumbers.appendChild(kmGroup);
  fgNumbers.appendChild(expGroup);
  fgNumbers.appendChild(budgetGroup);

  // √©tapes GPS
  const fgStops = createElem("div", "field-group mt-2");
  fgStops.innerHTML = `<label>√âtapes de la journ√©e (comme sur un GPS)</label>`;
  const stopsWrapper = createElem("div", "mt-1");
  renderStopsList(day, stopsWrapper);
  fgStops.appendChild(stopsWrapper);

  const btnAddStop = createElem("button", "btn btn-ghost btn-xs mt-1", "+ Ajouter une √©tape");
  btnAddStop.addEventListener("click", () => {
    day.stops.push({ id: ensureStopId(), name: "", lat: null, lng: null });
    saveState();
    renderDayDetail();
  });
  fgStops.appendChild(btnAddStop);

  // r√©sum√© √©tapes
  const fgRoutes = createElem("div", "field-group mt-2");
  fgRoutes.innerHTML = `<label>R√©sum√© g√©ographique des √©tapes</label>`;
  const routesWrapper = createElem("div", "mt-1");
  renderRoutesSummary(day, routesWrapper);
  fgRoutes.appendChild(routesWrapper);

  // NEW: dossier
  const fgFiles = createElem("div", "field-group mt-2");
  fgFiles.innerHTML = `
    <label>Dossier (billets / r√©servations)</label>
    <div class="hint">Stock√© dans ton navigateur (IndexedDB). Pas inclus dans l‚Äôexport JSON.</div>
    <input type="file" id="dayFiles" multiple style="margin-top:6px">
    <div id="filesList" class="routes-list mt-1"><div class="small muted" style="padding:6px 8px">Chargement‚Ä¶</div></div>
  `;
  fgStops.appendChild(createElem("div","mt-2",""));
  col2.appendChild(fgNumbers);
  col2.appendChild(fgStops);
  col2.appendChild(fgRoutes);
  col2.appendChild(fgFiles);

  grid.appendChild(col1);
  grid.appendChild(col2);
  container.appendChild(grid);

  const callout = createElem("div", "callout mt-2");
  callout.innerHTML = `
    <div class="callout-icon">üí°</div>
    <div>
      <strong>Mode GPS</strong> ‚Äî Liste tes √©tapes dans l‚Äôordre (ex: "Neuch√¢tel", "Walibi Holland", "Groningen", "Farup Sommerland").
      La carte calcule le trajet voiture, la distance totale et une estimation du temps de route. Les d√©penses sont ensuite calcul√©es (carburant + cat√©gories).
    </div>
  `;
  container.appendChild(callout);

  // bindings
  $("#dayLabel").addEventListener("input", (e) => {
    day.label = e.target.value;
    saveState();
    renderDaysList();
  });
  $("#dayDate").addEventListener("input", (e) => {
    day.date = e.target.value;
    saveState();
    renderDaysList();
  });
  $("#dayStart").addEventListener("input", (e) => {
    day.start = e.target.value;
    saveState();
    renderDaysList();
  });
  $("#dayEnd").addEventListener("input", (e) => {
    day.end = e.target.value;
    saveState();
    renderDaysList();
  });
  $("#daySummary").addEventListener("input", (e) => {
    day.summary = e.target.value;
    saveState();
    renderDaysList();
  });
  $("#dayNotes").addEventListener("input", (e) => {
    day.notes = e.target.value;
    saveState();
  });

  // lodging info bindings
  $("#lodgingName").addEventListener("input",(e)=>{ day.lodging.name=e.target.value; saveState(); });
  $("#lodgingAddress").addEventListener("input",(e)=>{ day.lodging.address=e.target.value; saveState(); });
  $("#lodgingCheckin").addEventListener("input",(e)=>{ day.lodging.checkin=e.target.value; saveState(); });
  $("#lodgingCheckout").addEventListener("input",(e)=>{ day.lodging.checkout=e.target.value; saveState(); });
  $("#lodgingNotes").addEventListener("input",(e)=>{ day.lodging.notes=e.target.value; saveState(); });

  $("#dayDriveHours").addEventListener("input", (e) => {
    const v = e.target.value;
    day.driveHours = v === "" ? null : Number(v);
    saveState();
    renderDaysList();
  });

  $("#dayKm").addEventListener("input", (e) => {
    const v = e.target.value;
    day.km = v === "" ? null : Number(v);
    if (day.budgetAuto) {
      const { total } = computeTotalBudget(day);
      day.budget = Math.round(total);
    }
    saveState();
    renderDaysList();
    renderDayDetail();
  });

  // expense bindings
  function updateExpenses(){
    if (day.budgetAuto) {
      const { total } = computeTotalBudget(day);
      day.budget = Math.round(total);
    }
    saveState();
    renderDaysList();
    renderDayDetail();
  }
  $("#costActivities").addEventListener("input",(e)=>{ day.costActivities = e.target.value===""?null:Number(e.target.value); updateExpenses(); });
  $("#costFood").addEventListener("input",(e)=>{ day.costFood = e.target.value===""?null:Number(e.target.value); updateExpenses(); });
  $("#costLodging").addEventListener("input",(e)=>{ day.costLodging = e.target.value===""?null:Number(e.target.value); updateExpenses(); });
  $("#costOther").addEventListener("input",(e)=>{ day.costOther = e.target.value===""?null:Number(e.target.value); updateExpenses(); });

  $("#dayBudget").addEventListener("input", (e) => {
    const v = e.target.value;
    day.budget = v === "" ? null : Number(v);
    // si tu modifies le total, on passe en manuel automatiquement
    day.budgetAuto = false;
    saveState();
    renderDaysList();
    renderDayDetail();
  });

  // files binding
  const fileInput = $("#dayFiles");
  const filesList = $("#filesList");

  async function refreshFiles(){
    const items = await listFilesForDay(day.id);
    filesList.innerHTML = "";
    if(!items.length){
      filesList.appendChild(createElem("div", "small muted", "Aucun fichier pour ce jour."));
      filesList.firstChild.style.padding = "6px 8px";
      return;
    }
    items.forEach(rec=>{
      const row = createElem("div", "route-row");
      const sizeKb = rec.size ? Math.round(rec.size/1024) : 0;
      const date = rec.lastModified ? new Date(rec.lastModified).toLocaleDateString() : "";
      row.innerHTML = `
        <div class="route-badge">üìÑ</div>
        <div>
          <div style="color:#e5e7eb">${rec.name}</div>
          <div class="route-meta">${date} ¬∑ ${sizeKb} KB</div>
        </div>
        <div style="display:flex;gap:6px;align-items:center">
          <button class="stop-btn" data-act="dl">‚¨á</button>
          <button class="stop-delete-btn" data-act="del">‚úï</button>
        </div>
      `;
      row.querySelector('[data-act="dl"]').addEventListener("click",(ev)=>{
        ev.stopPropagation();
        downloadBlob(rec.name, rec.blob);
      });
      row.querySelector('[data-act="del"]').addEventListener("click", async (ev)=>{
        ev.stopPropagation();
        await deleteFile(rec.id);
        refreshFiles();
      });
      filesList.appendChild(row);
    });
  }

  fileInput.addEventListener("change", async (e)=>{
    const files = e.target.files;
    if(files && files.length){
      await addFilesForDay(day.id, files);
      fileInput.value = "";
      await refreshFiles();
    }
  });

  refreshFiles();
}

/* ---------- DAYS ---------- */

function addDay() {
  const newDay = normalizeDay({
    id: ensureDayId(),
    label: `Jour ${days.length + 1}`,
    date: "",
    summary: "",
    notes: "",
    start: "",
    end: "",
    km: null,
    driveHours: null,
    budget: null,
    budgetAuto: true,
    costActivities: null,
    costLodging: null,
    costFood: null,
    costOther: null,
    lodging: { name:"", address:"", checkin:"", checkout:"", notes:"" },
    stops: [],
    route: null
  });
  days.push(newDay);
  selectDay(newDay.id);
  drawRoutesForDay(newDay);
}

function exportTrip() {
  const payload = {
    meta: {
      key: STORE_KEY,
      version: 2,
      exportedAt: new Date().toISOString(),
      note: "Les fichiers du 'Dossier' ne sont pas inclus (stock√©s s√©par√©ment via IndexedDB)."
    },
    days
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `trip-${tripSlug}-${tripYear}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}

function importTripFromFile(file) {
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const parsed = JSON.parse(reader.result);
      if (parsed && Array.isArray(parsed.days)) {
        days = parsed.days;
      } else if (Array.isArray(parsed)) {
        days = parsed;
      } else {
        throw new Error("Format inattendu");
      }
      days = days.map(normalizeDay);

      if (!days.length) {
        let def = prompt("Combien de jours tu veux pour ce voyage ?", "10");
        let n = parseInt(def, 10);
        if (!Number.isFinite(n) || n <= 0) n = 10;
        days = [];
        for (let i=0;i<n;i++){
          days.push(normalizeDay({
            id: ensureDayId(),
            label: `Jour ${i+1}`,
            date:"",
            summary:"",
            notes:"",
            start:"",
            end:"",
            km:null,
            driveHours:null,
            budget:null,
            budgetAuto:true,
            costActivities:null,
            costLodging:null,
            costFood:null,
            costOther:null,
            lodging:{ name:"", address:"", checkin:"", checkout:"", notes:"" },
            stops:[],
            route:null
          }));
        }
      }

      selectedDayId = OVERVIEW_ID;
      meta.lastSelectedDayId = OVERVIEW_ID;
      saveState();
      renderDaysList();
      renderDayDetail();
      drawRoutesForOverview();
    } catch (e) {
      alert("Fichier JSON invalide ou format non reconnu.");
      console.error(e);
    }
  };
  reader.readAsText(file);
}

/* ---------- RESIZE ---------- */

function initResize() {
  const handle = document.getElementById('dragHandle');
  const detailCol = document.querySelector('.detail-column');
  const rightCols = document.querySelector('.right-columns');
  if (!handle || !detailCol || !rightCols) return;

  let dragging = false;
  let startX = 0;
  let startWidth = 0;

  handle.addEventListener('mousedown', (e) => {
    dragging = true;
    handle.classList.add('dragging');
    startX = e.clientX;
    startWidth = detailCol.getBoundingClientRect().width;
    document.body.style.userSelect = 'none';
  });

  window.addEventListener('mousemove', (e) => {
    if (!dragging) return;
    const delta = e.clientX - startX;
    const containerWidth = rightCols.getBoundingClientRect().width;
    let newWidth = startWidth + delta;

    const minDetail = 320;
    const maxDetail = containerWidth - 260;
    newWidth = clamp(newWidth, minDetail, maxDetail);

    detailCol.style.flex = `0 0 ${newWidth}px`;
    if (map) map.invalidateSize();
  });

  window.addEventListener('mouseup', () => {
    if (!dragging) return;
    dragging = false;
    handle.classList.remove('dragging');
    document.body.style.userSelect = '';
  });
}

/* ---------- INIT ---------- */

document.addEventListener("DOMContentLoaded", () => {
  loadState();

  if (!days.length) {
    let answer = prompt("Combien de jours tu veux pour ce voyage ?", "10");
    let n = parseInt(answer, 10);
    if (!Number.isFinite(n) || n <= 0) n = 10;
    days = [];
    for (let i=0;i<n;i++){
      days.push(normalizeDay({
        id: ensureDayId(),
        label: `Jour ${i+1}`,
        date:"",
        summary:"",
        notes:"",
        start:"",
        end:"",
        km:null,
        driveHours:null,
        budget:null,
        budgetAuto:true,
        costActivities:null,
        costLodging:null,
        costFood:null,
        costOther:null,
        lodging:{ name:"", address:"", checkin:"", checkout:"", notes:"" },
        stops:[],
        route:null
      }));
    }
    saveState();
  }

  // restore selection
  if (meta.lastSelectedDayId && (meta.lastSelectedDayId === OVERVIEW_ID || days.some(d=>d.id===meta.lastSelectedDayId))){
    selectedDayId = meta.lastSelectedDayId;
  } else {
    selectedDayId = OVERVIEW_ID;
    meta.lastSelectedDayId = OVERVIEW_ID;
    saveState();
  }

  initMap();
  renderDaysList();
  renderDayDetail();

  if (selectedDayId === OVERVIEW_ID) drawRoutesForOverview();
  else drawRoutesForDay(getSelectedDay());

  initResize();

  $("#addDay").addEventListener("click", addDay);
  $("#exportTrip").addEventListener("click", exportTrip);
  $("#importTrip").addEventListener("click", () => $("#fileInput").click());
  $("#fileInput").addEventListener("change", (e) => {
    const f = e.target.files[0];
    if (f) importTripFromFile(f);
  });
});
</script>

</body>
</html>
